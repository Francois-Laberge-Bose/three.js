<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>High Fidelity Spatial Audio API Example - Simple</title>
    </head>
    
    <body style="width: 100%; height: 100%; margin: 0; padding: 0;">
        <button class="connectButton" style="width: 100%; height: 200px; margin: 0;" onclick="connectToHiFiAudio()">Click to Connect</button>
        <audio controls autoplay class="outputAudioEl" style="width: 100%; height: 75px; margin: 30px 0 0 0;"></audio>
    </body>

    <script src="./js/vendors/HighFidelityAudio-latest.js"></script>
    <script>
        // We use this to change the text of the "Connect" button to "Connected", and to disable that button after clicking it.
        let connectButton = document.querySelector('.connectButton');

        async function connectToHiFiAudio(stream) {
            // Disable the Connect button after the user clicks it so we don't double-connect.
            connectButton.disabled = true;
            connectButton.innerHTML = `Connecting...`;

            // Get the audio media stream associated with the user's default audio input device.
            let audioMediaStream;
            try {
                audioMediaStream = await navigator.mediaDevices.getUserMedia({ audio: HighFidelityAudio.getBestAudioConstraints(), video: false });
            } catch (e) {
                return;
            }

            // Set up the initial data for our user.
            // They'll be standing at the origin, facing "forward".
            let initialHiFiAudioAPIData = new HighFidelityAudio.HiFiAudioAPIData({
                position: new HighFidelityAudio.Point3D({ "x": 0, "y": 0, "z": 0 }),
                orientationEuler: new HighFidelityAudio.OrientationEuler3D({ "pitch": 0, "yaw": 0, "roll": 0 })
            });

            // Set up our `HiFiCommunicator` object, supplying our media stream and initial user data.
            let hifiCommunicator = new HighFidelityAudio.HiFiCommunicator({
                initialHiFiAudioAPIData: initialHiFiAudioAPIData
            });
            await hifiCommunicator.setInputAudioMediaStream(audioMediaStream);

            // Connect to the HiFi Audio API server!
            // Supply your own JWT here.
            const HIFI_AUDIO_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBfaWQiOiJhZmJiNGI3MS0yODY0LTRkNDQtYjA5ZS0xZDQwOGE5MjYyNzQiLCJzcGFjZV9pZCI6Ijc2MTE1ODBhLTk1OWMtNDU2Ni1hODRmLTQxMWMzZjNhN2QwOCIsInVzZXJfaWQiOiJHb29leSBUZXN0IElEIiwic3RhY2siOiJhdWRpb25ldC1taXhlci1hcGktYWxwaGEtMDEifQ.vuoq0gVeEilQRfrE7VRETaZ35ylMqg0rqVOxAInM4fQ";
            try {
                await hifiCommunicator.connectToHiFiAudioAPIServer(HIFI_AUDIO_JWT);
            } catch (e) {
                console.error(`Error connecting to High Fidelity:\n${e}`);
                connectButton.disabled = false;
                connectButton.innerHTML = `Connection error. Retry?`;
                return;
            }

            // Show the user that we're connected by changing the text on the button.
            connectButton.innerHTML = `Connected!`;

            // Set the `srcObject` on our `audio` DOM element to the final, mixed audio stream from the High Fidelity Audio API Server.
            document.querySelector(`.outputAudioEl`).srcObject = hifiCommunicator.getOutputAudioMediaStream();
            // We explicitly call `play()` here because certain browsers won't play the newly-set stream automatically.
            document.querySelector(`.outputAudioEl`).play();
        }
    </script>
</html>